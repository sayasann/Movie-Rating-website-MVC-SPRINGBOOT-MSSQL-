<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head(${movie.title})}"></head>

<body>
<div th:replace="~{fragments/navbar :: navbar('movies')}"></div>

<style>
	/* Daha temiz slider görünümü: scrollbar gizle */
	#similar-scroll::-webkit-scrollbar, #actors-scroll::-webkit-scrollbar { display: none; }
	#similar-scroll, #actors-scroll { -ms-overflow-style: none; scrollbar-width: none; }


	.scroll-btn {
		z-index: 1000 !important;
		cursor: pointer !important;
		pointer-events: auto !important;
		background-color: white !important;
		border: 1px solid #ddd !important;
		width: 45px;
		height: 45px;
		box-shadow: 0 4px 6px rgba(0,0,0,0.1);
	}
	.scroll-btn:hover {
		background-color: #f8f9fa !important;
		transform: translateY(-50%) scale(1.1);
	}
</style>

<div class="container my-5">

	<div th:if="${error}" class="alert alert-warning mb-4">
		<i class="bi bi-exclamation-triangle me-1"></i>
		<span th:text="${error}"></span>
	</div>

	<div class="d-flex justify-content-between align-items-start mb-4">

		<a th:href="@{/movies}" class="btn btn-sm btn-outline-secondary">
			← Back to Movies
		</a>

		<div class="d-flex flex-column align-items-end gap-2">

			<form th:if="${session.loggedUser != null}"
				  th:action="@{/users/favorites/{id}(id=${movie.id})}"
				  method="post">
				<button type="submit"
						class="btn btn-sm"
						th:classappend="${isFavorite} ? 'btn-warning' : 'btn-outline-warning'">
					<i class="bi"
					   th:classappend="${isFavorite} ? 'bi-star-fill' : 'bi-star'"></i>
					<span th:text="${isFavorite ? 'Unfavorite' : 'Favorite'}"></span>
				</button>
			</form>

			<form th:if="${session.loggedUser != null}"
				  th:action="@{/users/watchlist/{id}(id=${movie.id})}"
				  method="post">

				<button type="submit"
						class="btn btn-sm"
						th:classappend="${isWatched} ? 'btn-outline-secondary disabled'
			                            : (${inWatchList} ? 'btn-primary' : 'btn-outline-primary')"
						th:disabled="${isWatched}">

					<i class="bi bi-clock"></i>

					<span th:text="${isWatched}
			                        ? 'Already Watched'
			                        : 'Watch Later'">
			        </span>
				</button>
			</form>

			<form th:if="${session.loggedUser != null}"
				  th:action="@{/users/watched/{id}(id=${movie.id})}"
				  method="post">
				<button type="submit"
						class="btn btn-sm"
						th:classappend="${isWatched} ? 'btn-success' : 'btn-outline-success'">
					<i class="bi bi-check-circle"></i>
					Watched
				</button>
			</form>

			<p class="text-muted mt-2 mb-0" th:if="${session.loggedUser == null}">
				To manage lists, please <a th:href="@{/users/login}">login</a>.
			</p>

		</div>
	</div>

	<div class="row g-4">

		<div class="col-md-4 col-lg-3">
			<div class="rounded overflow-hidden border bg-light" style="aspect-ratio: 2 / 3;">
				<img th:if="${movie.posterLink != null && !#strings.isEmpty(movie.posterLink)}"
					 th:src="${movie.posterLink}"
					 class="w-100 h-100"
					 style="object-fit: cover;">
				<div th:if="${movie.posterLink == null || #strings.isEmpty(movie.posterLink)}"
					 class="w-100 h-100 d-flex align-items-center justify-content-center text-muted">
					<div class="text-center">
						<i class="bi bi-film fs-2"></i>
						<div>No poster</div>
					</div>
				</div>
			</div>
		</div>

		<div class="col-md-8 col-lg-9">

			<div class="d-flex flex-wrap align-items-end gap-2">
				<h1 class="mb-0" th:text="${movie.title}">Movie Title</h1>
				<span class="text-muted fs-5"
					  th:text="${movie.releaseYear != null ? '(' + movie.releaseYear + ')' : ''}">
                </span>
			</div>

			<div class="mt-3 d-flex flex-wrap gap-2">
                <span class="badge text-bg-dark"
					  th:text="'IMDb: ' + ${movie.imdbRating != null ? movie.imdbRating : 'N/A'}">
                </span>

				<span class="badge text-bg-secondary"
					  th:text="'Metascore: ' + ${movie.metaScore != null ? movie.metaScore : 'N/A'}">
                </span>

				<span class="badge text-bg-light border text-dark"
					  th:text="${movie.certificate != null ? movie.certificate : 'Unrated'}">
                </span>

				<span class="badge text-bg-light border text-dark"
					  th:text="${movie.duration != null ? movie.duration + ' min' : 'Duration: N/A'}">
                </span>
			</div>

			<div class="mt-3 text-muted">
                <span>
                    <strong>Director:</strong>
                    <span th:text="${movie.director != null ? movie.director : 'N/A'}">Director</span>
                </span>

				<span class="mx-2">•</span>

				<span>
                    <strong>Votes:</strong>
                    <span th:text="${movie.noOfVotes != null ? movie.noOfVotes : 'N/A'}">123,456</span>
                </span>

				<span class="mx-2">•</span>

				<span>
                    <strong>Genres:</strong>

                    <span th:if="${movie.genres == null || #lists.isEmpty(movie.genres)}">N/A</span>

                    <span th:if="${movie.genres != null && !#lists.isEmpty(movie.genres)}">
                        <span th:each="g, stat : ${movie.genres}">
                            <span th:text="${g.name}">Genre</span><span th:if="${!stat.last}">, </span>
                        </span>
                    </span>
                </span>
			</div>

			<div class="mt-4">
				<h4 class="mb-2 fw-bold">Overview</h4>
				<p class="mb-0 text-muted"
				   th:text="${movie.overview != null && !#strings.isEmpty(movie.overview) ? movie.overview : 'No overview available.'}">
					Overview...
				</p>
			</div>
		</div>
	</div>

	<hr class="my-5">

	<div>
		<div class="d-flex align-items-center justify-content-between mb-3">
			<h3 class="mb-0 fw-bold">Cast</h3>
			<span class="text-secondary fw-semibold small"
				  th:text="${movie.actors != null ? #lists.size(movie.actors) + ' actors' : '0 actors'}">0 actors</span>
		</div>

		<div class="alert alert-light border" th:if="${movie.actors == null || #lists.isEmpty(movie.actors)}">
			No cast information available.
		</div>

		<div th:if="${movie.actors != null && !#lists.isEmpty(movie.actors)}" class="position-relative">

			<button type="button"
					class="btn rounded-circle scroll-btn position-absolute top-50 start-0 translate-middle-y d-flex align-items-center justify-content-center"
					onclick="scrollActors(-1)">
				‹
			</button>

			<button type="button"
					class="btn rounded-circle scroll-btn position-absolute top-50 end-0 translate-middle-y d-flex align-items-center justify-content-center"
					onclick="scrollActors(1)">
				›
			</button>

			<div id="actors-scroll"
				 class="d-flex gap-3 overflow-auto px-5 py-2"
				 style="scroll-behavior: smooth; position: relative; z-index: 1;">

				<div class="flex-shrink-0" style="width: 180px;" th:each="a : ${movie.actors}">
					<a class="text-decoration-none"
					   th:href="@{/actors/detail/{actorid}(actorid=${a.id},movieId=${movie.id})}">
						<div class="card h-100 shadow-sm">
							<div class="bg-light" style="aspect-ratio: 1 / 1; overflow:hidden;">
								<img th:if="${a.imageLink != null && !#strings.isEmpty(a.imageLink)}"
									 th:src="${a.imageLink}"
									 alt="actor"
									 class="w-100 h-100"
									 style="object-fit: cover;">
								<div th:if="${a.imageLink == null || #strings.isEmpty(a.imageLink)}"
									 class="w-100 h-100 d-flex align-items-center justify-content-center text-muted">
									<i class="bi bi-person" style="font-size: 2rem;"></i>
								</div>
							</div>

							<div class="card-body p-2">
								<div class="fw-semibold text-dark" th:text="${a.name}">Actor Name</div>
							</div>
						</div>
					</a>
				</div>

			</div>
		</div>
	</div>

	<div class="mt-4">
		<div class="d-flex align-items-center justify-content-between mb-3">
			<h3 class="mb-0 fw-bold">You may also like</h3>
			<span class="text-secondary fw-semibold small"
				  th:text="${similarMovies == null ? '0 movies' : #lists.size(similarMovies) + ' movies'}">
                0 movies
            </span>
		</div>

		<div class="alert alert-light border"
			 th:if="${similarMovies == null || #lists.isEmpty(similarMovies)}">
			No recommendations available.
		</div>

		<div class="position-relative" th:if="${similarMovies != null && !#lists.isEmpty(similarMovies)}">

			<button type="button"
					class="btn rounded-circle scroll-btn position-absolute top-50 start-0 translate-middle-y d-flex align-items-center justify-content-center"
					onclick="scrollSimilar(-1)">
				‹
			</button>

			<button type="button"
					class="btn rounded-circle scroll-btn position-absolute top-50 end-0 translate-middle-y d-flex align-items-center justify-content-center"
					onclick="scrollSimilar(1)">
				›
			</button>

			<div id="similar-scroll"
				 class="d-flex gap-3 overflow-auto px-5 py-2"
				 style="scroll-behavior: smooth; position: relative; z-index: 1;">

				<div class="flex-shrink-0"
					 style="width: 180px;"
					 th:each="sm : ${similarMovies}">

					<a th:href="@{/movies/{id}(id=${sm.id})}"
					   class="text-decoration-none">

						<div class="card h-100 shadow-sm">

							<div class="bg-light" style="aspect-ratio: 2 / 3; overflow:hidden;">
								<img th:if="${sm.posterLink != null && !#strings.isEmpty(sm.posterLink)}"
									 th:src="${sm.posterLink}"
									 class="w-100 h-100"
									 style="object-fit: cover;">
								<div th:if="${sm.posterLink == null || #strings.isEmpty(sm.posterLink)}"
									 class="w-100 h-100 d-flex align-items-center justify-content-center text-muted">
									<i class="bi bi-film" style="font-size: 2rem;"></i>
								</div>
							</div>

							<div class="card-body p-2">
								<div class="fw-semibold text-dark" style="line-height:1.2;"
									 th:text="${sm.title}">Movie</div>

								<div class="text-secondary small"
									 th:text="${sm.releaseYear != null ? sm.releaseYear : ''}">2024</div>
							</div>

						</div>
					</a>
				</div>

			</div>
		</div>
	</div>

	<hr class="my-5">

	<section id="reviews">
		<div class="d-flex align-items-center justify-content-between mb-3">
			<h3 class="mb-0 fw-bold">Reviews</h3>
			<span class="text-secondary fw-semibold small"
				  th:text="${movie.reviews == null ? '0 reviews' : #lists.size(movie.reviews) + ' reviews'}">
                0 reviews
            </span>
		</div>

		<div class="card shadow-sm mb-4" th:if="${session.loggedUser != null}">
			<div class="card-body">
				<h5 class="mb-3 fw-bold">Add a review</h5>

				<form id="reviewForm"
					  th:action="@{/movies/reviews/{id}(id=${movie.id})}"
					  method="post">

					<div class="mb-3">
						<div class="fw-semibold mb-2">Rating</div>

						<input type="hidden" id="ratingInput" name="rating" value="">

						<div class="btn-group flex-wrap" role="group" aria-label="Rating">
							<button type="button" class="btn btn-outline-dark btn-sm rating-btn" data-value="1">1</button>
							<button type="button" class="btn btn-outline-dark btn-sm rating-btn" data-value="2">2</button>
							<button type="button" class="btn btn-outline-dark btn-sm rating-btn" data-value="3">3</button>
							<button type="button" class="btn btn-outline-dark btn-sm rating-btn" data-value="4">4</button>
							<button type="button" class="btn btn-outline-dark btn-sm rating-btn" data-value="5">5</button>
							<button type="button" class="btn btn-outline-dark btn-sm rating-btn" data-value="6">6</button>
							<button type="button" class="btn btn-outline-dark btn-sm rating-btn" data-value="7">7</button>
							<button type="button" class="btn btn-outline-dark btn-sm rating-btn" data-value="8">8</button>
							<button type="button" class="btn btn-outline-dark btn-sm rating-btn" data-value="9">9</button>
							<button type="button" class="btn btn-outline-dark btn-sm rating-btn" data-value="10">10</button>
						</div>

						<div class="small text-muted mt-2" id="ratingHint">Select a rating (1–10).</div>
					</div>

					<div class="mb-3">
						<label for="reviewText" class="form-label fw-semibold">Review</label>
						<textarea id="reviewText"
								  name="review"
								  class="form-control"
								  rows="4"
								  placeholder="Write your review..."
								  required></textarea>
					</div>

					<div class="form-check mb-3">
						<input class="form-check-input" type="checkbox" id="spoilerCheck" name="spoiler" value="true">
						<label class="form-check-label" for="spoilerCheck">
							This review contains spoilers
						</label>
					</div>

					<button type="submit" class="btn btn-dark">Submit</button>

				</form>
			</div>
		</div>

		<div class="alert alert-light border mb-4" th:if="${session.loggedUser == null}">
			To add a review, please <a th:href="@{/users/login}">login</a>.
		</div>

		<div class="alert alert-light border"
			 th:if="${movie.reviews == null || #lists.isEmpty(movie.reviews)}">
			No reviews yet.
		</div>

		<div class="vstack gap-3"
			 th:if="${movie.reviews != null && !#lists.isEmpty(movie.reviews)}">

			<div class="card shadow-sm" th:each="r : ${movie.reviews}">
				<div class="card-body">

					<div class="d-flex justify-content-between align-items-start">
						<div>
							<div class="fw-semibold"
								 th:text="${r.user != null && r.user.userName != null ? r.user.userName : 'Anonymous'}">
								Anonymous
							</div>

							<div class="small text-muted"
								 th:text="${r.date != null ? #dates.format(r.date,'yyyy-MM-dd HH:mm') : ''}">
							</div>
						</div>

						<div class="d-flex align-items-start gap-2">

                            <span class="badge text-bg-dark"
								  th:if="${r.rating != null}"
								  th:text="${r.rating} + '/10'">8/10</span>

							<form th:if="${session.loggedUser != null && r.user != null && r.user.userID == session.loggedUser.userID}"
								  th:action="@{/movies/reviews/delete/{movieId}/{reviewId}(movieId=${movie.id},reviewId=${r.id})}"
								  method="post"
								  class="d-inline">
								<button type="submit"
										class="btn btn-outline-danger btn-sm"
										onclick="return confirm('Delete this review?');">
									Delete
								</button>
							</form>

						</div>
					</div>

					<div class="mt-2" th:if="${r.isSpoiler == true}">
						<span class="badge bg-warning text-dark">Spoiler</span>
					</div>

					<div class="mt-3 review-text"
						 th:classappend="${r.isSpoiler == true} ? 'spoiler-blur' : ''"
						 th:text="${r.review != null && !#strings.isEmpty(r.review) ? r.review : 'No review text.'}">
					</div>

				</div>
			</div>

		</div>
	</section>

	<script>
		// Rating butonu scripti
		(function () {
			const ratingInput = document.getElementById('ratingInput');
			const hint = document.getElementById('ratingHint');
			const buttons = document.querySelectorAll('.rating-btn');

			if (!ratingInput || buttons.length === 0) return;

			buttons.forEach(btn => {
				btn.addEventListener('click', () => {
					const val = btn.getAttribute('data-value');
					ratingInput.value = val;
					buttons.forEach(b => b.classList.remove('active'));
					btn.classList.add('active');
					if (hint) hint.textContent = 'Selected: ' + val + '/10';
				});
			});
		})();

		function scrollByStep(containerId, direction) {
			const container = document.getElementById(containerId);
			if (!container) return;

			// Her basışta ~1 kart kaydır
			const step = 200;
			container.scrollBy({ left: direction * step, behavior: 'smooth' });
		}

		function scrollSimilar(direction) {
			scrollByStep('similar-scroll', direction);
		}

		function scrollActors(direction) {
			scrollByStep('actors-scroll', direction);
		}


	</script>

	<script>
		document.getElementById('reviewForm').addEventListener('submit', function (e) {
			if (!document.getElementById('ratingInput').value) {
				e.preventDefault();
				alert('Please select a rating (1–10).');
			}
		});
	</script>

</div>

<div th:replace="~{fragments/footer :: footer}"></div>
<script th:src="@{/js/theme.js}" defer></script>

</body>
</html>